# Backend Modernisation & Extensibility — TODO Roadmap
*Draft generated 2025-06-21*

> A structured backlog that closes current gaps, standardises wiring, and keeps the system modular so new API providers & agents drop in with minimal friction.

---

## PHASE 0 – House-Keeping (≤ 1 day)

| ID | Task |
|----|------|
| 0-1 | Update `MASTER_STATUS.md` & `CAPABILITIES_CATALOG.md` to freeze **v1.8.0-beta** baseline |
| 0-2 | Enable Sentry DSN in `core/sentry_config.py`; env-var sanity check in docker-compose |
| 0-3 | Expose Prometheus `/metrics` in local compose → verify baseline traffic & cost counters |

---

## PHASE 1 – Unify **Data Input → Graph → Cache** Pipeline

| ID | Task | Notes |
|----|------|-------|
| 1-1 | **Provider Registry** (`backend/providers/registry.yaml` + loader) | id, type (`rest`/`graphql`/`ws`), base_url, auth_key |
| 1-2 | **AbstractApiTool** base class | Common retry/back-off, Prometheus timer, cost tag.  All Sim tools subclass. |
| 1-3 | Harden `core/events.py` | Typed events: `GraphAddEvent`, `CacheAddEvent`, `LLMUsageEvent`; decorator `@subscribe(event)` |
| 1-4 | `neo4j_loader.py` helpers | `ingest_balances()`, `ingest_activity()`… single schema touch-point |
| 1-5 | Redis tiering | DB 0 = short-term cache, DB 1 = vector store; `redis_client.py` wrapper |

---

## PHASE 2 – Modular Agent / Crew Platform

| ID | Task |
|----|------|
| 2-1 | Formal **crew config convention** (`crews/<domain>/crew.yaml`, `tasks/*.yaml`) |
| 2-2 | Toggle sequential / hierarchical / planning via `CREW_MODE` env | tests for all paths |
| 2-3 | Centralise prompt templates (`agents/prompts/`) |
| 2-4 | Tool auto-discovery stub (MCP-ready) – scan `agents/tools` at startup, expose `/api/v1/tools` |
| 2-5 | Generic HITL scaffold – pause webhook, review endpoints, `hitl_reviews` table |

---

## PHASE 3 – Data → LLM Loop (RAG & Explainability)

| ID | Task |
|----|------|
| 3-1 | **Graph-Aware RAG** service – embed subgraphs → Redis Vector |
| 3-2 | Standard **EvidenceBundle** object (`narrative`, `evidence`, `raw`) |
| 3-3 | “Explain-with-Cypher” prototype – store & cite generated Cypher queries |

---

## PHASE 4 – Extensibility Hooks (open door for new APIs)

| ID | Task |
|----|------|
| 4-1 | Provider → Tool code-gen script (`scripts/new_provider_scaffold.py`) |
| 4-2 | Integration-test matrix: spin mock provider → assert Neo4j ingest |
| 4-3 | Cost / rate-limit Grafana dashboard (`external_api_call_total`, `credit_used_total`) |

---

## PHASE 5 – Polish & Harden

| ID | Task |
|----|------|
| 5-1 | Add OpenTelemetry spans to FastAPI + CrewAI |
| 5-2 | Back-pressure middleware: queue tasks if provider budget low |
| 5-3 | “Add new data source” cookbook in memory-bank docs |
| 5-4 | End-to-end load test (1 M rows + 100 k agent queries) |

---

## Suggested Timeline

| Week | Deliverable |
|------|-------------|
| 1 | Phase 0 + Provider registry/base tool (Phase 1) → tag **1.8.1** |
| 2–3 | Complete Phase 1 pipeline |
| 3 | Phase 2 crew refactor & HITL scaffold |
| 4 | Phase 3 (Graph-RAG) → release **1.9.0-alpha** |
| 5 | Phase 4 scaffolds & code-gen script |
| 6 | Phase 5 hardening & docs |

---

### Impact Recap
* Single Provider registry + AbstractApiTool ⇒ new feeds (Alchemy, Bitquery) in minutes.  
* Graph-aware RAG ⇒ LLM answers grounded in fresh on-chain truth.  
* Planner + modular crew YAML ⇒ Analysts (or another LLM) can compose new workflows declaratively.  
* Evidence bundles + HITL ⇒ Audit-ready outputs, regulator-friendly.

> _Generated by Factory Droid on 2025-06-21_.
